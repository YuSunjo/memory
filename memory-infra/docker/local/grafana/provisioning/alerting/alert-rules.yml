apiVersion: 1

groups:
  - name: memory-api-alerts
    orgId: 1
    folder: Memory API
    interval: 1m
    rules:
      # 🚨 Critical Alerts
      - uid: service-down
        title: Memory API Service Down
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasource:
              type: prometheus
              uid: prometheus
            model:
              expr: up{job="memory-api"}
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 30s
        annotations:
          summary: "Memory API service is down"
          description: "Memory API has been down for more than 30 seconds"
        labels:
          severity: critical
        
      - uid: high-jvm-heap
        title: High JVM Heap Usage
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasource:
              type: prometheus
              uid: prometheus
            model:
              expr: (jvm_memory_used_bytes{job="memory-api",area="heap"} / jvm_memory_max_bytes{job="memory-api",area="heap"}) * 100 > 85
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "JVM heap memory usage is critically high"
          description: "JVM heap memory usage is above 85% for more than 2 minutes"
        labels:
          severity: critical

      # ⚠️ Warning Alerts  
      - uid: high-response-time
        title: High Response Time
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasource:
              type: prometheus
              uid: prometheus
            model:
              expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket{job="memory-api"}[5m])) > 2
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "High response latency detected"
          description: "95th percentile latency is above 2 seconds for more than 2 minutes"
        labels:
          severity: warning

      - uid: high-error-rate
        title: High Server Error Rate
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasource:
              type: prometheus
              uid: prometheus
            model:
              expr: (rate(http_server_requests_seconds_count{job="memory-api",status=~"5.."}[5m]) / rate(http_server_requests_seconds_count{job="memory-api"}[5m])) * 100 > 5
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          summary: "High server error rate detected"
          description: "Server error rate is above 5% for more than 2 minutes"
        labels:
          severity: warning

      - uid: high-cpu-usage
        title: High CPU Usage
        condition: A
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasource:
              type: prometheus
              uid: prometheus
            model:
              expr: system_cpu_usage{job="memory-api"} * 100 > 80
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for more than 5 minutes"
        labels:
          severity: warning