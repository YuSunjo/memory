apiVersion: 1

groups:
  - name: memory-api-alerts-prod
    orgId: 1
    folder: Memory API
    interval: 30s
    rules:
      # üö® Critical Alert - Service Down (Îçî Îπ†Î•∏ Î∞òÏùë)
      - uid: service-down-prod
        title: üî• Memory API Service Down [PROD] üî•
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              disableTextWrap: false
              editorMode: builder
              expr: up{job="memory-api"}
              fullMetaSearch: false
              includeNullMetadata: true
              instant: true
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: A
              useBackend: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 15s
        annotations:
          summary: "üö® CRITICAL: Memory API service is DOWN in PRODUCTION üö®"
          description: "Memory API has been down for more than 15 seconds in PRODUCTION environment"
        labels:
          severity: critical
          environment: production

      # üö® Critical Alert - High JVM Heap (Îçî ÎÇÆÏùÄ ÏûÑÍ≥ÑÍ∞í)
      - uid: high-jvm-heap-prod
        title: High JVM Heap Usage [PROD]
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              disableTextWrap: false
              editorMode: builder
              expr: (jvm_memory_used_bytes{job="memory-api",area="heap"} / jvm_memory_max_bytes{job="memory-api",area="heap"}) * 100
              fullMetaSearch: false
              includeNullMetadata: true
              instant: true
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: A
              useBackend: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 75
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          summary: "JVM heap memory usage is critically high [PROD]"
          description: "JVM heap memory usage is above 75% for more than 1 minute in PRODUCTION"
        labels:
          severity: critical
          environment: production

      # üö® Critical Alert - Database Connection Pool
      - uid: high-db-connections-prod
        title: Database Connection Pool Critical [PROD]
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              disableTextWrap: false
              editorMode: builder
              expr: (hikari_connections_active{job="memory-api"} / hikari_connections_max{job="memory-api"}) * 100
              fullMetaSearch: false
              includeNullMetadata: true
              instant: true
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: A
              useBackend: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 85
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 30s
        annotations:
          summary: "Database connection pool usage critical [PROD]"
          description: "Active database connections above 85% in PRODUCTION"
        labels:
          severity: critical
          environment: production

      # ‚ö†Ô∏è Warning Alert - High Response Time (Îçî ÏóÑÍ≤©Ìïú ÏûÑÍ≥ÑÍ∞í)
      - uid: high-response-time-prod
        title: High Response Time [PROD]
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              disableTextWrap: false
              editorMode: builder
              expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket{job="memory-api"}[5m]))
              fullMetaSearch: false
              includeNullMetadata: true
              instant: true
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: A
              useBackend: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1.5
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          summary: "High response latency detected [PROD]"
          description: "95th percentile latency is above 1.5 seconds for more than 1 minute in PRODUCTION"
        labels:
          severity: warning
          environment: production

      # ‚ö†Ô∏è Warning Alert - High Error Rate (Îçî ÏóÑÍ≤©Ìïú ÏûÑÍ≥ÑÍ∞í)
      - uid: high-error-rate-prod
        title: High Server Error Rate [PROD]
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              disableTextWrap: false
              editorMode: builder
              expr: (rate(http_server_requests_seconds_count{job="memory-api",status=~"5.."}[5m]) / rate(http_server_requests_seconds_count{job="memory-api"}[5m])) * 100
              fullMetaSearch: false
              includeNullMetadata: true
              instant: true
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: A
              useBackend: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          summary: "High server error rate detected [PROD]"
          description: "Server error rate is above 2% for more than 1 minute in PRODUCTION"
        labels:
          severity: warning
          environment: production

      # ‚ö†Ô∏è Warning Alert - High CPU Usage (Îçî ÏóÑÍ≤©Ìïú ÏûÑÍ≥ÑÍ∞í)
      - uid: high-cpu-usage-prod
        title: High CPU Usage [PROD]
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              disableTextWrap: false
              editorMode: builder
              expr: system_cpu_usage{job="memory-api"} * 100
              fullMetaSearch: false
              includeNullMetadata: true
              instant: true
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: A
              useBackend: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 70
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 3m
        annotations:
          summary: "High CPU usage detected [PROD]"
          description: "CPU usage is above 70% for more than 3 minutes in PRODUCTION"
        labels:
          severity: warning
          environment: production

      # ‚ö†Ô∏è Warning Alert - Low Disk Space
      - uid: disk-space-low-prod
        title: Low Disk Space [PROD]
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              disableTextWrap: false
              editorMode: builder
              expr: (disk_free_bytes{job="memory-api"} / disk_total_bytes{job="memory-api"}) * 100
              fullMetaSearch: false
              includeNullMetadata: true
              instant: true
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: A
              useBackend: false
          - refId: C
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 15
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          summary: "Disk space critically low [PROD]"
          description: "Free disk space is below 15% in PRODUCTION"
        labels:
          severity: warning
          environment: production